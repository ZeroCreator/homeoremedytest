<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Тесты по гомеопатии{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% block styles %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- Шапка -->
        <header class="header">
            <div class="header-container">
                <div class="logo">
                    <a href="{{ url_for('index') }}">
                        <i class="fas fa-pills"></i>
                        <span>HomeoRemedyTest</span>
                    </a>
                </div>

                <nav class="main-nav">
                    <a href="{{ url_for('index') }}" class="nav-link {% if request.path == '/' %}active{% endif %}">
                        <i class="fas fa-home"></i> Главная
                    </a>
                    <a href="{{ url_for('create_card') }}" class="nav-link {% if request.path == '/create' %}active{% endif %}">
                        <i class="fas fa-plus-circle"></i> Добавить вопрос
                    </a>
                </nav>

                <!-- Переключатель режимов -->
                <div class="view-toggle">
                    {% set current_view = request.args.get('view', 'grid') %}
                    {% set current_theme = request.args.get('theme', '') %}
                    {% set current_search = request.args.get('search', '') %}
                    {% set current_show_hidden = request.args.get('show_hidden', 'false') %}

                    <a href="{{ url_for('index') }}?view=grid{% if current_theme %}&theme={{ current_theme }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_show_hidden == 'true' %}&show_hidden=true{% endif %}"
                       class="view-btn {% if current_view != 'stack' %}active{% endif %}"
                       title="Режим сетки">
                        <i class="fas fa-th-large"></i>
                    </a>
                    <a href="{{ url_for('index') }}?view=stack{% if current_theme %}&theme={{ current_theme }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_show_hidden == 'true' %}&show_hidden=true{% endif %}"
                       class="view-btn {% if current_view == 'stack' %}active{% endif %}"
                       title="Режим стопки карточек">
                        <i class="fas fa-layer-group"></i>
                    </a>
                </div>

                <!-- Выпадающее меню действий -->
                <div class="header-actions">
                    <div class="dropdown">
                        <button class="header-btn dropdown-toggle" title="Действия">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="{{ url_for('create_card') }}" class="dropdown-item">
                                <i class="fas fa-plus"></i> Добавить вопрос
                            </a>
                            <a href="{{ url_for('export_xlsx') }}" class="dropdown-item">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </a>
                            <a href="{{ url_for('import_cards') }}" class="dropdown-item">
                                <i class="fas fa-file-import"></i> Импорт из Excel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Боковая панель -->
                <aside class="sidebar">
                    {% block sidebar %}
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">
                            <i class="fas fa-filter"></i> Фильтры
                        </h3>

                        <div class="search-box">
                            <form method="get" action="{{ url_for('index') }}" id="search-form">
                                <!-- Сохраняем текущий режим просмотра -->
                                <input type="hidden" name="view" value="{{ request.args.get('view', 'grid') }}">
                                <!-- Сохраняем фильтр по теме -->
                                {% if current_theme %}
                                <input type="hidden" name="theme" value="{{ current_theme }}">
                                {% endif %}
                                <!-- Сохраняем фильтр скрытых карточек -->
                                <input type="hidden" name="show_hidden" value="{{ show_hidden|lower }}">

                                <div class="search-input">
                                    <i class="fas fa-search"></i>
                                    <input type="text"
                                           name="search"
                                           placeholder="Поиск по вопросам..."
                                           value="{{ search_query }}"
                                           class="search-field"
                                           id="search-input">
                                    {% if search_query %}
                                    <button type="button" class="clear-search" onclick="clearSearch()" title="Очистить поиск">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </form>
                        </div>

                        <!-- Фильтр скрытых карточек -->
                        <div class="hidden-filter">
                            <h4><i class="fas fa-eye-slash"></i> Скрытые карточки</h4>
                            <div class="toggle-switch">
                                <label class="switch">
                                    <input type="checkbox"
                                           id="show-hidden-toggle"
                                           {% if show_hidden %}checked{% endif %}
                                           onchange="toggleHiddenFilter(this)">
                                    <span class="slider"></span>
                                </label>
                                <span class="toggle-label">
                                    {% if show_hidden %}
                                    <i class="fas fa-eye"></i> Показаны все
                                    {% else %}
                                    <i class="fas fa-eye-slash"></i> Скрытые скрыты
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <div class="theme-filters" id="theme-filters">
                            <h4 class="accordion-header" onclick="toggleAccordion()">
                                <i class="fas fa-tags"></i>
                                <span>Темы</span>
                                <i class="accordion-icon fas fa-chevron-down"></i>
                            </h4>
                            <div class="theme-list" id="theme-list">
                                <!-- Ссылка "Все темы" с сохранением режима просмотра -->
                                {% set current_view = request.args.get('view', 'grid') %}
                                <a href="?view={{ current_view }}&show_hidden={{ show_hidden|lower }}"
                                   class="theme-filter {% if not current_theme %}active{% endif %}">
                                    <i class="fas fa-layer-group"></i> Все темы
                                    <span class="theme-count">{{ total_cards }}</span>
                                </a>

                                {% for theme in all_themes %}
                                <!-- Каждая тема с сохранением режима просмотра -->
                                <a href="{{ url_for('index') }}?view={{ current_view }}&theme={{ theme }}&show_hidden={{ show_hidden }}"
                                   class="theme-filter {% if current_theme == theme %}active{% endif %}">
                                    <i class="fas fa-tag"></i> {{ theme }}
                                    <span class="theme-count">{{ theme_counts.get(theme, 0) if theme_counts else 0 }}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="stats">
                            <h4><i class="fas fa-chart-bar"></i> Статистика</h4>
                            <div class="stat-item">
                                <span class="stat-label">Всего вопросов:</span>
                                <span class="stat-value">{{ total_cards }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Уникальных тем:</span>
                                <span class="stat-value">{{ all_themes|length }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Скрытых карточек:</span>
                                <span class="stat-value">{{ hidden_count }}</span>
                            </div>
                            {% if current_theme %}
                            <div class="stat-item">
                                <span class="stat-label">По теме "{{ current_theme }}":</span>
                                <span class="stat-value">{{ theme_counts.get(current_theme, 0) if theme_counts else 0 }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endblock %}
                </aside>

                <!-- Основное содержимое -->
                <section class="content-area">
                    <!-- Flash сообщения -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            <div class="flash-messages">
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category }}">
                                        {% if category == 'success' %}
                                            <i class="fas fa-check-circle"></i>
                                        {% elif category == 'error' %}
                                            <i class="fas fa-exclamation-circle"></i>
                                        {% elif category == 'info' %}
                                            <i class="fas fa-info-circle"></i>
                                        {% elif category == 'warning' %}
                                            <i class="fas fa-exclamation-triangle"></i>
                                        {% endif %}
                                        {{ message }}
                                        <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}

                    {% block content %}{% endblock %}
                </section>
            </div>
        </main>

        <!-- Подвал -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h4>HomeoRemedyTest</h4>
                        <p>Платформа для тестирования знаний по гомеопатии</p>
                    </div>
                    <div class="footer-section">
                        <h4></h4>
                        <a href="{{ url_for('index') }}"></a>
                        <a href="{{ url_for('create_card') }}"></a>
                        <a href="{{ url_for('import_cards') }}"></a>
                    </div>
                    <div class="footer-section">
                        <h4>Контакты</h4>
                        <p>По вопросам и предложениям: shkola.olga@gmail.com</p>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; {{ current_year }} HomeoRemedyTest. Все права защищены.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Скрипты -->
    <script>
        // Автопоиск с задержкой
        let searchTimeout;
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    e.target.form.submit();
                }, 500);
            });
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            if (input) {
                input.value = '';
                // Сохраняем текущие параметры в форме
                const form = input.form;
                form.submit();
            }
        }

        // Переключение фильтра скрытых карточек
        function toggleHiddenFilter(checkbox) {
            const showHidden = checkbox.checked;
            const url = new URL(window.location.href);
            const currentView = '{{ request.args.get("view", "grid") }}';

            // Устанавливаем все параметры
            if (showHidden) {
                url.searchParams.set('show_hidden', 'true');
            } else {
                url.searchParams.delete('show_hidden');
            }

            // Сохраняем режим просмотра
            if (currentView !== 'grid') {
                url.searchParams.set('view', currentView);
            } else {
                url.searchParams.delete('view');
            }

            window.location.href = url.toString();
        }

        // Автоматическое скрытие flash сообщений через 5 секунд
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });
        }, 100);

        // Функция переключения аккордеона
        function toggleAccordion() {
            // Работает только на мобильных
            if (window.innerWidth <= 768) {
                const themeFilters = document.getElementById('theme-filters');
                const themeList = document.getElementById('theme-list');

                themeFilters.classList.toggle('collapsed');

                // Если открываем, прокручиваем к активной теме
                if (!themeFilters.classList.contains('collapsed')) {
                    setTimeout(() => {
                        const activeTheme = document.querySelector('.theme-filter.active');
                        if (activeTheme) {
                            // Прокручиваем список к активной теме
                            themeList.scrollTop = activeTheme.offsetTop - 20;
                        }
                    }, 100);
                }

                // Добавляем/убираем возможность скролла для body при открытом аккордеоне
                if (!themeFilters.classList.contains('collapsed')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        // Закрываем аккордеон при клике на тему и возвращаем скролл
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.theme-filter').forEach(filter => {
                filter.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        const themeFilters = document.getElementById('theme-filters');
                        // Небольшая задержка перед закрытием
                        setTimeout(() => {
                            themeFilters.classList.add('collapsed');
                            document.body.style.overflow = ''; // Восстанавливаем скролл
                        }, 300);
                    }
                });
            });

            // Инициализируем аккордеон как свернутый на мобильных
            if (window.innerWidth <= 768) {
                const themeFilters = document.getElementById('theme-filters');
                themeFilters.classList.add('collapsed');
            }
        });

        // Восстанавливаем скролл при изменении размера окна
        window.addEventListener('resize', function() {
            document.body.style.overflow = '';

            const themeFilters = document.getElementById('theme-filters');
            if (!themeFilters) return;

            if (window.innerWidth <= 768) {
                // На мобильных - сворачиваем если не свернут
                if (!themeFilters.classList.contains('collapsed')) {
                    themeFilters.classList.add('collapsed');
                }
            } else {
                // На десктопах - разворачиваем и убираем класс collapsed
                themeFilters.classList.remove('collapsed');
            }
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
