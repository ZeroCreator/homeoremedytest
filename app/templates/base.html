<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Тесты по гомеопатии{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% block styles %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- Шапка -->
        <header class="header">
            <div class="header-container">
                <div class="logo">
                    <a href="{{ url_for('index') }}">
                        <i class="fas fa-pills"></i>
                        <span>HomeoRemedyTest</span>
                    </a>
                </div>

                <nav class="main-nav">
                    <a href="{{ url_for('index') }}" class="nav-link {% if request.path == '/' %}active{% endif %}">
                        <i class="fas fa-home"></i> Главная
                    </a>
                    <a href="{{ url_for('create_card') }}" class="nav-link {% if request.path == '/create' %}active{% endif %}">
                        <i class="fas fa-plus-circle"></i> Добавить вопрос
                    </a>
                </nav>

                <div class="header-actions">
                    <a href="{{ url_for('create_card') }}" class="add-btn" title="Добавить новый вопрос">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Боковая панель -->
                <aside class="sidebar">
                    {% block sidebar %}
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">
                            <i class="fas fa-filter"></i> Фильтры
                        </h3>

                        <div class="search-box">
                            <form method="get" action="{{ url_for('index') }}" id="search-form">
                                <div class="search-input">
                                    <i class="fas fa-search"></i>
                                    <input type="text"
                                           name="search"
                                           placeholder="Поиск по вопросам..."
                                           value="{{ search_query }}"
                                           class="search-field"
                                           id="search-input">
                                    {% if search_query %}
                                    <button type="button" class="clear-search" onclick="clearSearch()" title="Очистить поиск">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </form>
                        </div>

                        <div class="theme-filters" id="theme-filters">
                            <h4 onclick="toggleThemeFilters()">
                                <i class="fas fa-tags"></i> Темы
                            </h4>
                            <div class="theme-list" id="theme-list">
                                <a href="{{ url_for('index') }}"
                                   class="theme-filter {% if not current_theme %}active{% endif %}">
                                    <i class="fas fa-layer-group"></i> Все темы
                                    <span class="theme-count">{{ total_cards }}</span>
                                </a>

                                {% for theme in all_themes %}
                                {% set theme_count = cards|selectattr('theme', 'equalto', theme)|list|length if cards else 0 %}
                                <a href="{{ url_for('index', theme=theme) }}"
                                   class="theme-filter {% if current_theme == theme %}active{% endif %}">
                                    <i class="fas fa-tag"></i> {{ theme }}
                                    <span class="theme-count">{{ theme_count }}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="stats">
                            <h4><i class="fas fa-chart-bar"></i> Статистика</h4>
                            <div class="stat-item">
                                <span class="stat-label">Всего вопросов:</span>
                                <span class="stat-value">{{ total_cards }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Тем:</span>
                                <span class="stat-value">{{ all_themes|length }}</span>
                            </div>
                            {% if current_theme %}
                            <div class="stat-item">
                                <span class="stat-label">В этой теме:</span>
                                <span class="stat-value">{{ cards|length }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endblock %}
                </aside>

                <!-- Основное содержимое -->
                <section class="content-area">
                    <!-- Flash сообщения -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            <div class="flash-messages">
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category }}">
                                        {% if category == 'success' %}
                                            <i class="fas fa-check-circle"></i>
                                        {% elif category == 'error' %}
                                            <i class="fas fa-exclamation-circle"></i>
                                        {% elif category == 'info' %}
                                            <i class="fas fa-info-circle"></i>
                                        {% elif category == 'warning' %}
                                            <i class="fas fa-exclamation-triangle"></i>
                                        {% endif %}
                                        {{ message }}
                                        <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}

                    {% block content %}{% endblock %}
                </section>
            </div>
        </main>

        <!-- Подвал -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h4>HomeoRemedyTest</h4>
                        <p>Платформа для тестирования знаний по гомеопатии</p>
                    </div>
                    <div class="footer-section">
                        <h4>Быстрые ссылки</h4>
                        <a href="{{ url_for('index') }}">Главная</a>
                        <a href="{{ url_for('create_card') }}">Добавить вопрос</a>
                    </div>
                    <div class="footer-section">
                        <h4>Контакты</h4>
                        <p>По вопросам и предложениям:</p>
                        <p>shkola.olga@gmail.com</p>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; {{ current_year }} HomeoRemedyTest. Все права защищены.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Скрипты -->
    <script>
        // Автопоиск с задержкой
        let searchTimeout;
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    e.target.form.submit();
                }, 500);
            });
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            if (input) {
                input.value = '';
                input.form.submit();
            }
        }

        // Плавная прокрутка
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId === '#') return;

                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Автоматическое скрытие flash сообщений через 5 секунд
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });
        }, 100);
    </script>

    {% block scripts %}{% endblock %}

<script>
    // Фиксация сайдбара с учетом прокрутки
    function handleSidebarScroll() {
        const sidebar = document.querySelector('.sidebar');
        const contentArea = document.querySelector('.content-area');

        if (!sidebar || !contentArea) return;

        // Проверяем, нужно ли показывать/прятать сайдбар на мобильных
        if (window.innerWidth <= 1200) {
            sidebar.style.position = 'static';
            sidebar.style.top = '0';
            return;
        }

        // Рассчитываем, когда сайдбар должен перестать быть sticky
        const sidebarHeight = sidebar.offsetHeight;
        const contentHeight = contentArea.offsetHeight;
        const footer = document.querySelector('.footer');
        const footerOffset = footer ? footer.offsetTop : document.body.scrollHeight;

        // Если контент короче сайдбара или страницы, убираем sticky
        if (contentHeight < sidebarHeight || window.innerHeight >= footerOffset) {
            sidebar.style.position = 'relative';
            sidebar.style.top = '0';
        } else {
            sidebar.style.position = 'sticky';
            sidebar.style.top = 'calc(var(--header-height) + 30px)';
        }
    }

    // Вызываем при загрузке и изменении размера окна
    document.addEventListener('DOMContentLoaded', handleSidebarScroll);
    window.addEventListener('resize', handleSidebarScroll);
    window.addEventListener('scroll', handleSidebarScroll);

    // Плавная прокрутка к активной теме в сайдбаре
    function scrollToActiveTheme() {
        const activeTheme = document.querySelector('.theme-filter.active');
        const themeList = document.querySelector('.theme-list');

        if (activeTheme && themeList) {
            const themeListRect = themeList.getBoundingClientRect();
            const activeThemeRect = activeTheme.getBoundingClientRect();

            // Если активная тема не видна, прокручиваем к ней
            if (activeThemeRect.bottom > themeListRect.bottom ||
                activeThemeRect.top < themeListRect.top) {
                activeTheme.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }
        }
    }

    // Прокручиваем к активной теме после загрузки
    setTimeout(scrollToActiveTheme, 300);

        // Переключение аккордеона тем на мобильных
    function toggleThemeFilters() {
        if (window.innerWidth <= 768px) {
            const themeFilters = document.getElementById('theme-filters');
            themeFilters.classList.toggle('collapsed');
        }
    }

    // Автоматически сворачиваем на мобильных при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        if (window.innerWidth <= 768px) {
            const themeFilters = document.getElementById('theme-filters');
            if (themeFilters) {
                themeFilters.classList.add('collapsed');
            }
        }
    });

    // Пересворачиваем при изменении размера
    window.addEventListener('resize', function() {
        const themeFilters = document.getElementById('theme-filters');
        if (!themeFilters) return;

        if (window.innerWidth <= 768px && !themeFilters.classList.contains('collapsed')) {
            themeFilters.classList.add('collapsed');
        } else if (window.innerWidth > 768px) {
            themeFilters.classList.remove('collapsed');
        }
    });
</script>
</body>
</html>
