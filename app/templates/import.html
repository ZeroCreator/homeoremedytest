{% extends "base.html" %}

{% block title %}Импорт карточек - Тесты по гомеопатии{% endblock %}

{% block styles %}
<style>
.import-container {
    max-width: 800px;
    margin: 0 auto;
    background: var(--bg-primary);
    border-radius: var(--border-radius);
    padding: 40px;
    box-shadow: var(--shadow-md);
}

.import-header {
    text-align: center;
    margin-bottom: 40px;
}

.import-header h1 {
    color: var(--primary-color);
    font-size: 2rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.import-header p {
    color: var(--text-light);
    font-size: 1.1rem;
}

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius);
    padding: 60px 40px;
    text-align: center;
    margin-bottom: 30px;
    transition: all var(--transition-fast);
    background: var(--bg-light);
}

.upload-area:hover {
    border-color: var(--primary-color);
    background: var(--bg-secondary);
}

.upload-area.drag-over {
    border-color: var(--primary-color);
    background: var(--bg-secondary);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    color: var(--primary-color);
    margin-bottom: 20px;
}

.upload-text h3 {
    color: var(--text-primary);
    margin-bottom: 10px;
}

.upload-text p {
    color: var(--text-light);
    margin-bottom: 20px;
}

.file-input-wrapper {
    position: relative;
    display: inline-block;
}

.file-input-wrapper input[type="file"] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.file-input-label {
    display: inline-block;
    padding: 12px 30px;
    background: linear-gradient(to right, var(--primary-color), var(--primary-light));
    color: white;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
    transition: all var(--transition-fast);
}

.file-input-label:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.selected-file {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-primary);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 15px;
    display: none;
}

.selected-file.show {
    display: flex;
}

.selected-file i {
    color: var(--primary-color);
    font-size: 1.5rem;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    color: var(--text-primary);
    word-break: break-all;
}

.file-size {
    font-size: 0.9rem;
    color: var(--text-light);
}

.remove-file {
    background: none;
    border: none;
    color: var(--secondary-color);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 5px;
    border-radius: 50%;
    transition: background-color var(--transition-fast);
}

.remove-file:hover {
    background-color: rgba(255, 107, 107, 0.1);
}

.import-mode {
    margin-bottom: 30px;
}

.mode-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.mode-option {
    position: relative;
}

.mode-option input {
    position: absolute;
    opacity: 0;
}

.mode-label {
    display: block;
    padding: 20px;
    background: var(--bg-light);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
}

.mode-label:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.mode-option input:checked + .mode-label {
    background: rgba(74, 111, 165, 0.1);
    border-color: var(--primary-color);
    color: var(--primary-color);
    font-weight: 600;
}

.mode-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    display: block;
}

.mode-title {
    font-size: 1.1rem;
    margin-bottom: 5px;
    display: block;
}

.mode-description {
    font-size: 0.9rem;
    color: var(--text-light);
    display: block;
}

.preview-section {
    margin-bottom: 30px;
    display: none;
}

.preview-section.show {
    display: block;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.preview-header h3 {
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.preview-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.preview-table th {
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-weight: 600;
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 10;
}

.preview-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.preview-table tr:hover {
    background: var(--bg-light);
}

.preview-table tr:last-child td {
    border-bottom: none;
}

.import-actions {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.btn-back {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 12px 30px;
    border-radius: var(--border-radius);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    transition: all var(--transition-fast);
}

.btn-back:hover {
    background: var(--bg-light);
    transform: translateY(-2px);
}

.btn-import {
    background: linear-gradient(to right, #28a745, #20c997);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: all var(--transition-fast);
}

.btn-import:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-import:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.loading {
    display: none;
    text-align: center;
    padding: 20px;
    color: var(--text-light);
}

.loading.show {
    display: block;
}

.loading-spinner {
    border: 3px solid var(--bg-light);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .import-container {
        padding: 25px;
    }

    .mode-options {
        grid-template-columns: 1fr;
    }

    .upload-area {
        padding: 40px 20px;
    }

    .import-actions {
        flex-direction: column;
    }

    .preview-table {
        font-size: 0.8rem;
    }

    .preview-table th,
    .preview-table td {
        padding: 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="import-container">
    <div class="import-header">
        <h1><i class="fas fa-file-import"></i> Импорт карточек</h1>
        <p>Загрузите файл Excel для импорта вопросов в базу данных</p>
    </div>

    <form id="import-form" method="POST" action="{{ url_for('import_cards') }}" enctype="multipart/form-data">
        <!-- Область загрузки файла -->
        <div class="upload-area" id="upload-area">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">
                <h3>Перетащите файл Excel сюда</h3>
                <p>или нажмите для выбора файла</p>
                <div class="file-input-wrapper">
                    <input type="file" id="file-input" name="file" accept=".xlsx,.xls" required>
                    <label for="file-input" class="file-input-label">
                        <i class="fas fa-folder-open"></i> Выбрать файл
                    </label>
                </div>
            </div>
        </div>

        <!-- Выбранный файл -->
        <div class="selected-file" id="selected-file">
            <i class="fas fa-file-excel"></i>
            <div class="file-info">
                <div class="file-name" id="file-name"></div>
                <div class="file-size" id="file-size"></div>
            </div>
            <button type="button" class="remove-file" id="remove-file" title="Удалить файл">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Режим импорта -->
        <div class="import-mode">
            <h3><i class="fas fa-cog"></i> Режим импорта</h3>
            <div class="mode-options">
                <div class="mode-option">
                    <input type="radio" id="mode-append" name="mode" value="append" checked>
                    <label for="mode-append" class="mode-label">
                        <i class="fas fa-plus-circle mode-icon"></i>
                        <span class="mode-title">Добавить</span>
                        <span class="mode-description">Добавить новые карточки к существующим</span>
                    </label>
                </div>
                <div class="mode-option">
                    <input type="radio" id="mode-replace" name="mode" value="replace">
                    <label for="mode-replace" class="mode-label">
                        <i class="fas fa-sync-alt mode-icon"></i>
                        <span class="mode-title">Заменить</span>
                        <span class="mode-description">Удалить все текущие карточки и заменить новыми</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Предпросмотр -->
        <div class="preview-section" id="preview-section">
            <div class="preview-header">
                <h3><i class="fas fa-eye"></i> Предпросмотр данных</h3>
                <span class="preview-info" id="preview-info"></span>
            </div>
            <div class="preview-table-container">
                <table class="preview-table" id="preview-table">
                    <!-- Данные будут добавлены через JavaScript -->
                </table>
            </div>
        </div>

        <!-- Загрузка -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Обработка файла...</p>
        </div>

        <!-- Действия -->
        <div class="import-actions">
            <a href="{{ url_for('index') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Назад
            </a>
            <button type="submit" class="btn-import" id="import-btn" disabled>
                <i class="fas fa-upload"></i> Начать импорт
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const selectedFile = document.getElementById('selected-file');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');
    const previewSection = document.getElementById('preview-section');
    const previewTable = document.getElementById('preview-table');
    const previewInfo = document.getElementById('preview-info');
    const importBtn = document.getElementById('import-btn');
    const loading = document.getElementById('loading');
    const form = document.getElementById('import-form');

    let currentFile = null;

    // Обработка drag & drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            handleFileSelection(file);
        }
    });

    // Обработка выбора файла через input
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFileSelection(this.files[0]);
        }
    });

    // Удаление файла
    removeFileBtn.addEventListener('click', function() {
        resetFileSelection();
    });

    // Обработка выбора файла
    function handleFileSelection(file) {
        // Проверка типа файла
        const allowedTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                             'application/vnd.ms-excel'];
        const fileExt = file.name.split('.').pop().toLowerCase();

        if (!allowedTypes.includes(file.type) && !['xlsx', 'xls'].includes(fileExt)) {
            alert('Пожалуйста, выберите файл Excel (.xlsx или .xls)');
            return;
        }

        currentFile = file;

        // Показываем информацию о файле
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        selectedFile.classList.add('show');

        // Активируем кнопку импорта
        importBtn.disabled = false;

        // Показываем предпросмотр
        showPreview(file);
    }

    // Сброс выбора файла
    function resetFileSelection() {
        fileInput.value = '';
        currentFile = null;
        selectedFile.classList.remove('show');
        previewSection.classList.remove('show');
        importBtn.disabled = true;
    }

    // Форматирование размера файла
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Показ предпросмотра
    function showPreview(file) {
        loading.classList.add('show');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/import/preview', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loading.classList.remove('show');

            if (data.success) {
                displayPreview(data);
                previewSection.classList.add('show');
            } else {
                alert('Ошибка при предпросмотре файла: ' + data.error);
                resetFileSelection();
            }
        })
        .catch(error => {
            loading.classList.remove('show');
            alert('Ошибка при загрузке предпросмотра: ' + error);
            resetFileSelection();
        });
    }

    // Отображение предпросмотра
    function displayPreview(data) {
        previewInfo.textContent = `Показано ${data.shown_rows} из ${data.total_rows} строк`;

        // Очищаем таблицу
        previewTable.innerHTML = '';

        // Добавляем заголовки
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        data.preview[0].forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        previewTable.appendChild(thead);

        // Добавляем данные
        const tbody = document.createElement('tbody');

        for (let i = 1; i < data.preview.length; i++) {
            const row = document.createElement('tr');

            data.preview[i].forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell || '';
                td.title = cell || '';
                row.appendChild(td);
            });

            tbody.appendChild(row);
        }

        previewTable.appendChild(tbody);
    }

    // Подтверждение замены
    form.addEventListener('submit', function(e) {
        if (document.getElementById('mode-replace').checked) {
            if (!confirm('Внимание! Вы выбрали режим "Заменить". Все существующие карточки будут удалены и заменены новыми. Продолжить?')) {
                e.preventDefault();
                return false;
            }
        }

        // Показываем индикатор загрузки
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Импорт...';

        return true;
    });
});
</script>
{% endblock %}
